apiVersion: v1
kind: ConfigMap
metadata:
  name: relayer-env
  namespace: email-wallet-v11
  labels:
    app: relayer
data:
  CORE_CONTRACT_ADDRESS: "0xd9bd6903bB0D569e5236a58EcE7BF91831758978"
  CHAIN_RPC_EXPLORER: "https://base-sepolia.blockscout.com/"
  CHAIN_ID: "84532"
  CANISTER_ID: "fxmww-qiaaa-aaaaj-azu7a-cai"
  PEM_PATH: "/app/.ic.pem"
  IC_REPLICA_URL: "https://a4gq6-oaaaa-aaaab-qaa4q-cai.raw.icp0.io/?id=fxmww-qiaaa-aaaaj-azu7a-cai"
  WALLET_CANISTER_ID: "7u4p3-qqaaa-aaaaf-qanbq-cai"
  SMTP_SERVER: "http://smtp.email-wallet-v11.svc.cluster.local:3000/api/sendEmail"
  ERROR_EMAIL_ADDRESSES: "thezdev1@gmail.com"
  FEE_PER_GAS: "0"
  RELAYER_EMAIL_ADDR: "thezdev2@gmail.com"
  RELAYER_HOSTNAME: "gmail.com"
  WEB_SERVER_ADDRESS: "0.0.0.0:4500"
  CIRCUITS_DIR_PATH: "../circuits"
  SUBGRAPH_URL: "https://gateway-arbitrum.network.thegraph.com/api/305a386d2d64a4b9f94a05cdc9f4112c/subgraphs/id/AFNg1WfLo4dv1tfixaKCvWTVnFGEsVhVKx2Kef1dbt9G"
  INPUT_FILES_DIR_PATH: "./input_files/"
  EMAIL_TEMPLATES_PATH: "./eml_templates/"
  ONBOARDING_TOKEN_ADDR: "0x12Cee57B10AadAb156F61F757Aaf61FeE7d5f0Cb"
  ONBOARDING_TOKEN_AMOUNT: "100"
  ONBOARDING_TOKEN_DISTRIBUTION_LIMIT: "10"
  ONBOARDING_REPLY: "You received 100 TEST!"
  SAFE_API_ENDPOINT: "https://safe-transaction-base-sepolia.safe.global/api"
  JSON_LOGGER: "false"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: relayer
  namespace: email-wallet-v11
  labels:
    app: relayer
spec:
  selector:
    matchLabels:
      app: relayer
  template:
    metadata:
      labels:
        app: relayer
    spec:
      containers:
        - name: relayer-container
          image: zkfr/email-wallet-relayer:latest
          ports:
            - containerPort: 4500
          envFrom:
            - configMapRef:
                name: relayer-env
            - secretRef:
                name: relayer-secret
          livenessProbe:
            httpGet:
              path: /api/echo
              port: 4500
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/echo
              port: 4500
            initialDelaySeconds: 60
            periodSeconds: 30
          volumeMounts:
            - name: pem-volume
              mountPath: "/relayer/packages/relayer/.ic.pem"
              subPath: ".ic.pem"
        - name: smtp-container
          image: zkfr/smtp:latest
          ports:
            - containerPort: 3000
          envFrom:
            - secretRef:
                name: relayer-smtp-secret
        - name: imap-container
          image: zkfr/imap:latest
          envFrom:
            - secretRef:
                name: relayer-imap-secret
      volumes:
        - name: pem-volume
          secret:
            secretName: relayer-secret
            items:
              - key: ICPEM
                path: ".ic.pem"

---
apiVersion: v1
kind: Service
metadata:
  name: relayer-svc
  namespace: email-wallet-v11
  annotations:
    networking.gke.io/load-balancer-ip: "34.173.198.113"
spec:
  selector:
    app: relayer
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 4500
  type: LoadBalancer

---
apiVersion: v1
kind: Service
metadata:
  name: relayer-smtp-svc
  namespace: email-wallet-v11
spec:
  selector:
    app: relayer
  ports:
    - protocol: TCP
      port: 443
      targetPort: 3000
  type: ClusterIP
